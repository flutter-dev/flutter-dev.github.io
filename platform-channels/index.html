<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>使用平台通道编写平台特定代码  - Flutter </title>
  <link rel="shortcut icon" href="/images/favicon.png">

  <meta name="description" content="">
  <meta name="keywords" content=" ">

  <link rel="stylesheet" href="/css/lavish-bootstrap.css">
  <link rel="stylesheet" href="/css/main.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Extended" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro%7CRoboto:500,400italic,300,400" rel="stylesheet">
  
  <link rel="canonical" href="http://localhost:4000/platform-channels/">

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-67589403-1', 'auto');
    ga('send', 'pageview');
  </script>

  <meta name="google-site-verification" content="HFqxhSbf9YA_0rBglNLzDiWnrHiK_w4cqDh2YD2GEY4" />
</head>


  <body class="">

    <div id="overlay-under-drawer"><!-- for the drawer on narrow screens --></div>

    <header class="site-header">
  <div class="container-fluid header-contents">
    <div class="row">
      <div class="col-md-12">
        <i class="fa fa-bars" id="sidebar-toggle-button" aria-hidden="true" style="display:none"></i>
        <img src="/images/flutter-mark-square-100.png" alt="Flutter Logo" width="40" height="40" style="vertical-align:middle">

        <a class="site-title" href="/">Flutter</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon">
            <i class="material-icons-extended">more_vert</i>
          </a>
          <div class="trigger">
            <a class="page-link" href="/docs/">文档</a>
            <a class="page-link" href="https://github.com/flutter/flutter">GitHub</a>
            <a class="page-link" href="https://pub.dartlang.org/flutter">库</a>
            <a class="page-link" href="/support/">支持</a>
            <a class="page-link" href="http://flutter-dev.cn">论坛</a>
            <form action="/search/" class="nav-searchbox" id="cse-search-box" style="display: inline">
              <input type="hidden" name="cx" value="007067728241810524621:gm6vraqlc8c">
              <input type="hidden" name="ie" value="UTF-8">
              <input type="hidden" name="hl" value="en">
              <input type="search" name="q" id="q" autocomplete="off" placeholder="搜索">
            </form>
          </div>
        </nav>
      </div>
    </div> <!-- /.row -->
  </div> <!-- /.container -->
</header>


    <!-- Page Content -->
    <div class="container-fluid contents">
      <!-- Content Row -->
      <div class="row">

        <!-- Sidebar Column -->
        <div id="side-nav-container" class="col-sm-3">
          <ul id="mysidebar" class="nav">

  <li class="sidebar-title">入门</li>

    <ul class="sidebar-items">
      <li><a href="/get-started/install/">1: 安装</a></li>
      <li><a href="/get-started/editor/">2: 配置编辑器</a></li>
      <li><a href="/get-started/test-drive/">3: Flutter 初体验</a></li>
      <li><a href="/get-started/codelab/">4: 编写第一个 Flutter 应用</a></li>
      <li><a href="/get-started/learn-more/">5: 学习更多</a></li>
    </ul>

  <li class="sidebar-title">构建 UI</li>

    <ul class="sidebar-items">
      <li><a href="/widgets-intro/">框架预览</a></li>
      <li><a href="/widgets/">Widget 目录</a></li>
      <li><a href="/cookbook/">小案例</a></li>
      <li><a href="/catalog/samples/">示例目录</a></li>
      <li><a href="https://codelabs.developers.google.com/codelabs/flutter/index.html#0">构建漂亮的用户界面 - Codelab</a></li>
      <li><a href="/tutorials/layout/">构建布局 - 教程</a></li>
      <li><a href="/tutorials/interactive/">添加交互 - 教程</a></li>
      <li><a href="/web-analogs/">HTML/CSS 模式</a></li>
      <li><a href="/flutter-for-android/">Android 开发者参考</a></li>
      <li><a href="/flutter-for-react-native/">React Native 开发者参考</a></li>
      <li><a href="/gestures/">手势</a></li>
      <li><a href="/animations/">动画</a></li>
      <li><a href="/custom-fonts/">自定义字体</a></li>
      <li><a href="/layout/">框约束</a></li>
      <li><a href="/assets-and-images/">资源与图像</a></li>
      <li><a href="/text-input/">文本输入</a></li>
      <li><a href="/routing-and-navigation/">界面路由与导航</a></li>
      <li><a href="/tutorials/internationalization">国际化</a></li>
    </ul>

  <li class="sidebar-title">使用设备与 SDK 中的 API</li>

    <ul class="sidebar-items">
      <li><a href="/using-packages/">使用扩展包</a></li>
      <li><a href="/developing-packages/">开发扩展包</a></li>
      <li><a href="/platform-channels/">平台特定代码</a></li>
      <li><a href="/reading-writing-files/">文件的读写</a></li>
      <li><a href="/networking/">网络和 HTTP</a></li>
      <li><a href="/json/">JSON 和序列化</a></li>
      
    </ul>

  <li class="sidebar-title">开发与工具</li>

    <ul class="sidebar-items">
      <li><a href="/using-ide/">Flutter IDE 的使用</a></li>
      <li><a href="/hot-reload/">热重载的使用</a></li>
      <li><a href="/testing/">应用测试</a></li>
      <li><a href="/debugging/">应用调试</a></li>
      <li><a href="/inspector/">用户界面检查</a></li>
      <li><a href="/android-release/">编译正式版的 Android 应用</a></li>
      <li><a href="/ios-release/">编译正式版的 iOS 应用</a></li>
      <li><a href="/upgrading/">升级 Flutter</a></li>
      <li><a href="/formatting/"> 格式化代码</a></li>
    </ul>

  <li class="sidebar-title">更多细节</li>

    <ul class="sidebar-items">
      <li><a href="/faq/">FAQ</a></li>
      <li><a href="/technical-overview">技术一览</a></li>
      <li><a href="https://docs.google.com/presentation/d/1B3p0kP6NV_XMOimRV09Ms75ymIjU5gr6GGIX74Om_DE/edit?usp=sharing">神奇的 Flutter - 幻灯片</a></li>
      <li><a href="https://docs.google.com/presentation/d/1cw7A4HbvM_Abv320rVgPVGiUP2msVs7tfGbkgdrTy0I/edit?usp=sharing">架构图</a></li>
      <li><a href="https://www.bilibili.com/video/av14430321/">Flutter 框架层设计 <i class="fa fa-video-camera" aria-hidden="true"></i></a></li>
      <li><a href="https://www.bilibili.com/video/av6269773/">Flutter 的渲染管线 <i class="fa fa-video-camera" aria-hidden="true"></i></a></li>
    </ul>

</ul>

        </div>

        
        

        <!-- Content Column -->
        <div class="col-sm-9 main-contents">
          <div class="main-contents-body">
            <article class="post-content">
  
  
  <header class="post-header">
      <div class="btn-group contribute" role="group">
         <a href="https://github.com/flutter/website/blob/master/zh_CN/platform-channels.md" class="btn btn-sm">
            <i class="fa fa-pencil"></i> Edit Source
         </a>
         <a href="https://github.com/flutter/flutter/issues/new?title=Issue from website page 使用平台通道编写平台特定代码&body=From URL: http://localhost:4000/platform-channels/&labels=dev: docs - website" class="btn btn-sm">
            <i class="fa fa-github"></i> File Issue
        </a>
     </div>
   <div>
    <h1 class="post-title">使用平台通道编写平台特定代码 </h1>
   </div>

  </header>
  

  <p>本教程介绍了怎样编写平台特定代码。一些平台特定的功能在已存在的扩展包可以直接使用；请参阅 <a href="/using-packages/">using packages</a>.</p>

<ul id="markdown-toc">
  <li><a href="#architecture" id="markdown-toc-architecture">结构概述：平台通道</a>    <ul>
      <li><a href="#codec" id="markdown-toc-codec">平台通道支持的数据类型和编解码器</a></li>
    </ul>
  </li>
  <li><a href="#example" id="markdown-toc-example">示例: 使用平台通道调用平台特定的 iOS 和 Android 代码</a>    <ul>
      <li><a href="#example-project" id="markdown-toc-example-project">步骤 1: 创建新工程</a></li>
      <li><a href="#example-client" id="markdown-toc-example-client">步骤 2: 创建 Flutter 平台客户端</a></li>
      <li><a href="#example-java" id="markdown-toc-example-java">步骤 3a: 用 Java 添加 Android 平台特定实现</a></li>
      <li><a href="#example-kotlin" id="markdown-toc-example-kotlin">步骤 3b: 用 Kotlin 添加 Android 特定平台实现</a></li>
      <li><a href="#example-objc" id="markdown-toc-example-objc">步骤 4a: 用 Objective-C 添加 iOS 平台特定实现</a></li>
      <li><a href="#example-swift" id="markdown-toc-example-swift">步骤 4b: 用 Swift 添加 iOS 平台特定实现</a></li>
    </ul>
  </li>
  <li><a href="#separate" id="markdown-toc-separate">从 UI 代码中拆分平台特定的代码</a></li>
  <li><a href="#publish" id="markdown-toc-publish">发布平台特定代码为扩展包</a></li>
  <li><a href="#自定义通道和编解码器" id="markdown-toc-自定义通道和编解码器">自定义通道和编解码器</a></li>
</ul>

<p>Flutter 使用了一个灵活的系统允许你调用平台特定的接口，无论在 Android 上使用 Java 或 Kotlin, 在 iOS 上使用 ObjectiveC 或 Swift 代码都可以.</p>

<p>Flutter 对于平台特定接口的支持不依赖代码生成，而是基于灵活的消息传递的方式：</p>

<ul>
  <li>
    <p>应用程序的 Flutter 部分通过平台通道向其<em>主机</em>、应用程序的iOS或Android部分发送消息.</p>
  </li>
  <li>
    <p><em>宿主</em>监听平台通道，并接受消息。然后调用任意数量的平台特定接口 – 使用原生编程语言 – 并将响应发送回<em>客户端</em>，即应用的 Flutter 部分。</p>
  </li>
</ul>

<h2 id="architecture">结构概述：平台通道</h2>

<p>使用平台通道在客户端（UI）和宿主（平台）之间传递消息，如图所示：</p>

<p><img src="/images/PlatformChannels.png" alt="Platform channels architecture" /></p>

<p>为了让用户界面保持响应，消息和响应被异步传递。</p>

<p>在客户端这端，<code class="highlighter-rouge">MethodChannel</code> (<a href="https://docs.flutter.io/flutter/services/MethodChannel-class.html">API</a>) 可以发送与方法调用相对应的消息。在平台端，<code class="highlighter-rouge">MethodChannel</code> 在 Android (<a href="https://docs.flutter.io/javadoc/io/flutter/plugin/common/MethodChannel.html">API</a>) 和 iOS
(<a href="https://docs.flutter.io/objcdoc/Classes/FlutterMethodChannel.html">API</a>) 上能够接收方法调用并返回结果。这些类允许你通过很少的’样板’代码开发平台插件。</p>

<p><em>注意</em>：必要时，方法调用也可以反方向调用，平台作为客户端通过 Dart 实现方法。具体的例子在这里 <a href="https://pub.dartlang.org/packages/quick_actions"><code class="highlighter-rouge">quick_actions</code></a> 插件.</p>

<h3 id="codec">平台通道支持的数据类型和编解码器</h3>

<p>标准平台通道使用一个标准的消息编解码器。简单的JSON类值（如布尔值）的高效二进制序列化，数字、字符串、字节缓冲区以及这些列表和映射。(查看细节
<a href="https://docs.flutter.io/flutter/services/StandardMessageCodec-class.html"><code class="highlighter-rouge">StandardMessageCodec</code></a>)。这些值的序列化和反序列化在消息发送和接收值时自动发生。</p>

<p>下表展示了如何在平台上接收的 Dart 值，反之亦然：</p>

<table>
  <thead>
    <tr>
      <th>Dart</th>
      <th>Android</th>
      <th>iOS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>null</td>
      <td>null</td>
      <td>nil (NSNull when nested)</td>
    </tr>
    <tr>
      <td>bool</td>
      <td>java.lang.Boolean</td>
      <td>NSNumber numberWithBool:</td>
    </tr>
    <tr>
      <td>int</td>
      <td>java.lang.Integer</td>
      <td>NSNumber numberWithInt:</td>
    </tr>
    <tr>
      <td>int, if 32 bits not enough</td>
      <td>java.lang.Long</td>
      <td>NSNumber numberWithLong:</td>
    </tr>
    <tr>
      <td>int, if 64 bits not enough</td>
      <td>java.math.BigInteger</td>
      <td>FlutterStandardBigInteger</td>
    </tr>
    <tr>
      <td>double</td>
      <td>java.lang.Double</td>
      <td>NSNumber numberWithDouble:</td>
    </tr>
    <tr>
      <td>String</td>
      <td>java.lang.String</td>
      <td>NSString</td>
    </tr>
    <tr>
      <td>Uint8List</td>
      <td>byte[]</td>
      <td>FlutterStandardTypedData typedDataWithBytes:</td>
    </tr>
    <tr>
      <td>Int32List</td>
      <td>int[]</td>
      <td>FlutterStandardTypedData typedDataWithInt32:</td>
    </tr>
    <tr>
      <td>Int64List</td>
      <td>long[]</td>
      <td>FlutterStandardTypedData typedDataWithInt64:</td>
    </tr>
    <tr>
      <td>Float64List</td>
      <td>double[]</td>
      <td>FlutterStandardTypedData typedDataWithFloat64:</td>
    </tr>
    <tr>
      <td>List</td>
      <td>java.util.ArrayList</td>
      <td>NSArray</td>
    </tr>
    <tr>
      <td>Map</td>
      <td>java.util.HashMap</td>
      <td>NSDictionary</td>
    </tr>
  </tbody>
</table>

<p><br /></p>
<h2 id="example">示例: 使用平台通道调用平台特定的 iOS 和 Android 代码</h2>

<p>以下说明了怎么调用平台特定的接口来取得并显示当前的电池电量。通过单独的一个的平台消息，使用 Android <code class="highlighter-rouge">BatteryManager</code> 接口，和 iOS <code class="highlighter-rouge">device.batteryLevel</code> 接口。</p>

<p>示例在主应用中添加了平台特定代码。如果你想在多个应用程序中重用平台代码，创建工程的步骤略有不同 (请参阅 <a href="/developing-packages/#plugin">开发扩展包</a>)，但是平台通道代码使用同样的方法。</p>

<p><em>注意</em>：这个示例完整可运行的代码在这儿<a href="https://github.com/flutter/flutter/tree/master/examples/platform_channel"><code class="highlighter-rouge">/examples/platform_channel/</code></a>，该版本使用 Java  开发 Android，Objective-C 开发的 iOS。iOS 的 Swift 版本请参阅<a href="https://github.com/flutter/flutter/tree/master/examples/platform_channel_swift"><code class="highlighter-rouge">/examples/platform_channel_swift/</code></a>.</p>

<h3 id="example-project">步骤 1: 创建新工程</h3>

<p>开始创建新工程：</p>

<ul>
  <li>在终端运行: <code class="highlighter-rouge">flutter create batterylevel</code></li>
</ul>

<p>默认模板支持使用 Java 编写 Android，Objective-C 编写 iOS。想使用Kotlin 或者 Swift，使用 <code class="highlighter-rouge">-i</code> 与/或 <code class="highlighter-rouge">-a</code> 标记；</p>

<ul>
  <li>终端运行： <code class="highlighter-rouge">flutter create -i swift -a kotlin batterylevel</code></li>
</ul>

<h3 id="example-client">步骤 2: 创建 Flutter 平台客户端</h3>

<p>应用的 <code class="highlighter-rouge">State</code> 类持有当前应用的状态。我们需要扩展它来持有当前的电池状态。</p>

<p>首先，我们构造通道。我们使用 <code class="highlighter-rouge">MethodChannel</code> 编写单独的平台方法并返回电池变量。</p>

<p>通道的客户端和宿主端通过在构造器中传入通道名来连接。所有的通道名在一个应用中必须唯一；我们推荐使用唯一的’域名前缀’给通道名加前缀，如 <code class="highlighter-rouge">samples.flutter.io/battery</code>。</p>

<!-- skip -->
<div class="language-dart highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="s">'dart:async'</span><span class="o">;</span>

<span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/services.dart'</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">class</span> <span class="nc">_MyHomePageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyHomePage</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">const</span> <span class="n">platform</span> <span class="o">=</span> <span class="kd">const</span> <span class="n">MethodChannel</span><span class="o">(</span><span class="s">'samples.flutter.io/battery'</span><span class="o">);</span>

  <span class="c1">// Get battery level.</span>
<span class="o">}</span>
</code></pre>
</div>

<p>接下来，我们调用方法通道上的方法，指定具体方法。通过字符串标识符 <code class="highlighter-rouge">getBatteryLevel</code> 调用。调用也许会失败 – 例如如果平台不支持平台接口（比如运行在模拟器上），所以我们用语句块来包装<code class="highlighter-rouge">invokeMethod</code> 调用。我们拿到返回结果在 <code class="highlighter-rouge">setState</code> 里面用 <code class="highlighter-rouge">_batteryLevel</code> 更新用户界面状态。</p>

<!-- skip -->
<div class="language-dart highlighter-rouge"><pre class="highlight"><code>  <span class="c1">// Get battery level.</span>
  <span class="kt">String</span> <span class="n">_batteryLevel</span> <span class="o">=</span> <span class="s">'Unknown battery level.'</span><span class="o">;</span>

  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Null</span><span class="o">&gt;</span> <span class="n">_getBatteryLevel</span><span class="o">()</span> <span class="n">async</span> <span class="o">{</span>
    <span class="kt">String</span> <span class="n">batteryLevel</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="n">platform</span><span class="o">.</span><span class="na">invokeMethod</span><span class="o">(</span><span class="s">'getBatteryLevel'</span><span class="o">);</span>
      <span class="n">batteryLevel</span> <span class="o">=</span> <span class="s">'Battery level at </span><span class="si">$result</span><span class="s"> % .'</span><span class="o">;</span>
    <span class="o">}</span> <span class="n">on</span> <span class="n">PlatformException</span> <span class="k">catch</span> <span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">batteryLevel</span> <span class="o">=</span> <span class="s">"Failed to get battery level: '</span><span class="si">${e.message}</span><span class="s">'."</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">setState</span><span class="o">(()</span> <span class="o">{</span>
      <span class="n">_batteryLevel</span> <span class="o">=</span> <span class="n">batteryLevel</span><span class="o">;</span>
    <span class="o">});</span>
  <span class="o">}</span>
</code></pre>
</div>

<p>最后，我们把模板中的 <code class="highlighter-rouge">build</code> 方法替换为一个小的用户界面用字符串显示电池状态，还有一个按钮来刷新这个值。</p>

<!-- skip -->
<div class="language-dart highlighter-rouge"><pre class="highlight"><code><span class="nd">@override</span>
<span class="n">Widget</span> <span class="nf">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Material</span><span class="o">(</span>
    <span class="nl">child:</span> <span class="k">new</span> <span class="n">Center</span><span class="o">(</span>
      <span class="nl">child:</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span>
        <span class="nl">mainAxisAlignment:</span> <span class="n">MainAxisAlignment</span><span class="o">.</span><span class="na">spaceEvenly</span><span class="o">,</span>
        <span class="nl">children:</span> <span class="o">[</span>
          <span class="k">new</span> <span class="n">RaisedButton</span><span class="o">(</span>
            <span class="nl">child:</span> <span class="k">new</span> <span class="n">Text</span><span class="o">(</span><span class="s">'Get Battery Level'</span><span class="o">),</span>
            <span class="nl">onPressed:</span> <span class="n">_getBatteryLevel</span><span class="o">,</span>
          <span class="o">),</span>
          <span class="k">new</span> <span class="n">Text</span><span class="o">(</span><span class="n">_batteryLevel</span><span class="o">),</span>
        <span class="o">],</span>
      <span class="o">),</span>
    <span class="o">),</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="example-java">步骤 3a: 用 Java 添加 Android 平台特定实现</h3>

<p><em>注意</em>: 以下步骤使用 Java。如果你更喜欢 Kotlin，跳到步骤3b。</p>

<p>在 Android Studio 中打开 Android 宿主端：</p>

<ol>
  <li>
    <p>打开 Android Studio。</p>
  </li>
  <li>
    <p>选择菜单项 ‘文件 &gt; 打开…‘。</p>
  </li>
  <li>
    <p>导航到 Flutter 应用程序的目录，选择它里面的 <code class="highlighter-rouge">android</code> 文件夹。点击确定。</p>
  </li>
  <li>
    <p>在工程视图下打开位于 <code class="highlighter-rouge">java</code> 文件夹的 <code class="highlighter-rouge">MainActivity.java</code> 文件。</p>
  </li>
</ol>

<p>下一步，创建 <code class="highlighter-rouge">MethodChannel</code> 并在 <code class="highlighter-rouge">onCreate</code> 方法中设置 <code class="highlighter-rouge">MethodCallHandler</code>。确保使用了和 Flutter 客户端同样的通道名。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.flutter.app.FlutterActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel.MethodCallHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel.Result</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">FlutterActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CHANNEL</span> <span class="o">=</span> <span class="s">"samples.flutter.io/battery"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>

        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">MethodChannel</span><span class="o">(</span><span class="n">getFlutterView</span><span class="o">(),</span> <span class="n">CHANNEL</span><span class="o">).</span><span class="na">setMethodCallHandler</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">MethodCallHandler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMethodCall</span><span class="o">(</span><span class="n">MethodCall</span> <span class="n">call</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// TODO</span>
                    <span class="o">}</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>下一步，我们添加真正的 Android Java 代码，使用 Android 电池接口取到电池电量。这些代码和你编写原生的 Android 应用一样。</p>

<p>首先，在文件顶部添加必要的应用：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import android.content.ContextWrapper;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.BatteryManager;
import android.os.Build.VERSION;
import android.os.Build.VERSION_CODES;
import android.os.Bundle;
</code></pre>
</div>

<p>在 activity 类中 <code class="highlighter-rouge">onCreate</code> 的方法下面紧接着添加一个新的方法：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">int</span> <span class="nf">getBatteryLevel</span><span class="o">()</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">batteryLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">BatteryManager</span> <span class="n">batteryManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">BatteryManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">BATTERY_SERVICE</span><span class="o">);</span>
    <span class="n">batteryLevel</span> <span class="o">=</span> <span class="n">batteryManager</span><span class="o">.</span><span class="na">getIntProperty</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">BATTERY_PROPERTY_CAPACITY</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContextWrapper</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">()).</span>
        <span class="n">registerReceiver</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_BATTERY_CHANGED</span><span class="o">));</span>
    <span class="n">batteryLevel</span> <span class="o">=</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">EXTRA_LEVEL</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">*</span> <span class="mi">100</span><span class="o">)</span> <span class="o">/</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">EXTRA_SCALE</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="n">batteryLevel</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>最后，我们完成之前添加的 <code class="highlighter-rouge">onMethodCall</code> 方法。我们需要一个单一的平台方法，<code class="highlighter-rouge">getBatteryLevel</code>，我们在 <code class="highlighter-rouge">call</code> 参数中检测它。这个平台方法的实现调用了我们在之前步骤中写的 Android 代码，并在成功和错误的情况下都返回 <code class="highlighter-rouge">response</code> 参数。如果调用了一个未知的方法，我们会发出报告。替换：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMethodCall</span><span class="o">(</span><span class="n">MethodCall</span> <span class="n">call</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// TODO</span>
<span class="o">}</span>
</code></pre>
</div>

<p>为：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMethodCall</span><span class="o">(</span><span class="n">MethodCall</span> <span class="n">call</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"getBatteryLevel"</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">batteryLevel</span> <span class="o">=</span> <span class="n">getBatteryLevel</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">batteryLevel</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">batteryLevel</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"UNAVAILABLE"</span><span class="o">,</span> <span class="s">"Battery level not available."</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">notImplemented</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>               
</code></pre>
</div>

<p>你现在应该能够在 Android 系统上运行应用程序了。如果使用了 Android 模拟器，你可以在点击工具栏中的 <code class="highlighter-rouge">...</code> 按钮，在扩展控制栏设置电池电量。</p>

<h3 id="example-kotlin">步骤 3b: 用 Kotlin 添加 Android 特定平台实现</h3>

<p><em>注意</em>：以下步骤和步骤 3a 类似，除了用 Kotlin 代替 Java。</p>

<p>本步骤假设你在<a href="#example-project">步骤 1.</a>中使用 <code class="highlighter-rouge">-a kotlin</code> 选项创建工程。</p>

<p>在 Android Studio 中打开 Android 宿主端：</p>

<ol>
  <li>
    <p>打开 Android Studio。</p>
  </li>
  <li>
    <p>选择菜单项 ‘文件 &gt; 打开…‘。</p>
  </li>
  <li>
    <p>导航到 Flutter 应用程序的目录，选择它里面的 <code class="highlighter-rouge">android</code> 文件夹。点击确定。</p>
  </li>
  <li>
    <p>在工程视图下打开位于 <code class="highlighter-rouge">kotlin</code> 文件夹下的 <code class="highlighter-rouge">MainActivity.kt</code> 文件。(注意：如果你正在使用 Android Studio 2.3 编辑，’kotlin’ 文件夹将会显示名为 ’java’。）</p>
  </li>
</ol>

<p>下一步，创建 <code class="highlighter-rouge">MethodChannel</code> 并在 <code class="highlighter-rouge">onCreate</code> 方法中调用 <code class="highlighter-rouge">setMethodCallHandler </code>。确保使用了和 Flutter 客户端同样的通道名。</p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">android.os.Bundle</span>
<span class="k">import</span> <span class="nn">io.flutter.app.FlutterActivity</span>
<span class="k">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel</span>
<span class="k">import</span> <span class="nn">io.flutter.plugins.GeneratedPluginRegistrant</span>

<span class="kd">class</span> <span class="nc">MainActivity</span><span class="p">()</span> <span class="p">:</span> <span class="n">FlutterActivity</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">CHANNEL</span> <span class="p">=</span> <span class="s">"samples.flutter.io/battery"</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">GeneratedPluginRegistrant</span><span class="p">.</span><span class="n">registerWith</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

    <span class="n">MethodChannel</span><span class="p">(</span><span class="n">flutterView</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">).</span><span class="n">setMethodCallHandler</span> <span class="p">{</span> <span class="n">call</span><span class="p">,</span> <span class="n">result</span> <span class="p">-&gt;</span>
      <span class="c1">// TODO
</span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>下一步，我们添加真正的 Android Kotlin 代码，使用 Android 电池接口取到电池电量。这些代码和你编写原生的 Android 应用一样。</p>

<p>首先，在文件顶部添加必要的引用：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import android.content.Context
import android.content.ContextWrapper
import android.content.Intent
import android.content.IntentFilter
import android.os.BatteryManager
import android.os.Build.VERSION
import android.os.Build.VERSION_CODES
</code></pre>
</div>

<p>在 <code class="highlighter-rouge">MainActivity</code> 类中 <code class="highlighter-rouge">onCreate</code> 的方法下面紧接着添加一个新的方法：</p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>  <span class="k">private</span> <span class="k">fun</span> <span class="nf">getBatteryLevel</span><span class="p">():</span> <span class="n">Int</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">batteryLevel</span><span class="p">:</span> <span class="n">Int</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">VERSION</span><span class="p">.</span><span class="n">SDK_INT</span> <span class="p">&gt;=</span> <span class="n">VERSION_CODES</span><span class="p">.</span><span class="n">LOLLIPOP</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">batteryManager</span> <span class="p">=</span> <span class="n">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="n">BATTERY_SERVICE</span><span class="p">)</span> <span class="k">as</span> <span class="n">BatteryManager</span>
      <span class="n">batteryLevel</span> <span class="p">=</span> <span class="n">batteryManager</span><span class="p">.</span><span class="n">getIntProperty</span><span class="p">(</span><span class="n">BatteryManager</span><span class="p">.</span><span class="n">BATTERY_PROPERTY_CAPACITY</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">intent</span> <span class="p">=</span> <span class="n">ContextWrapper</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">).</span><span class="n">registerReceiver</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">IntentFilter</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="n">ACTION_BATTERY_CHANGED</span><span class="p">))</span>
      <span class="n">batteryLevel</span> <span class="p">=</span> <span class="n">intent</span><span class="o">!!</span><span class="p">.</span><span class="n">getIntExtra</span><span class="p">(</span><span class="n">BatteryManager</span><span class="p">.</span><span class="n">EXTRA_LEVEL</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="m">100</span> <span class="p">/</span> <span class="n">intent</span><span class="p">.</span><span class="n">getIntExtra</span><span class="p">(</span><span class="n">BatteryManager</span><span class="p">.</span><span class="n">EXTRA_SCALE</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">batteryLevel</span>
  <span class="p">}</span>
</code></pre>
</div>

<p>最后，我们完成之前添加的 <code class="highlighter-rouge">onMethodCall</code> 方法。我们需要一个单一的平台方法，<code class="highlighter-rouge">getBatteryLevel</code>，我们在 <code class="highlighter-rouge">call</code> 参数中检测它。这个平台方法的实现调用了我们在之前步骤中写的 Android 代码，并在成功和错误的情况下都返回 <code class="highlighter-rouge">response</code> 参数。如果调用了一个未知的方法，我们会发出报告。替换：</p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>    <span class="n">MethodChannel</span><span class="p">(</span><span class="n">flutterView</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">).</span><span class="n">setMethodCallHandler</span> <span class="p">{</span> <span class="n">call</span><span class="p">,</span> <span class="n">result</span> <span class="p">-&gt;</span>
      <span class="c1">// TODO
</span>    <span class="p">}</span>
</code></pre>
</div>

<p>为:</p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>    <span class="n">MethodChannel</span><span class="p">(</span><span class="n">flutterView</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">).</span><span class="n">setMethodCallHandler</span> <span class="p">{</span> <span class="n">call</span><span class="p">,</span> <span class="n">result</span> <span class="p">-&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">method</span> <span class="p">==</span> <span class="s">"getBatteryLevel"</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">batteryLevel</span> <span class="p">=</span> <span class="n">getBatteryLevel</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">batteryLevel</span> <span class="p">!=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">result</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">batteryLevel</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"UNAVAILABLE"</span><span class="p">,</span> <span class="s">"Battery level not available."</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">result</span><span class="p">.</span><span class="n">notImplemented</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>你现在应该能够在 Android 系统上运行应用程序了。如果使用了 Android 模拟器，你可以在点击工具栏中的 <code class="highlighter-rouge">...</code> 按钮，在扩展控制栏设置电池电量。</p>

<h3 id="example-objc">步骤 4a: 用 Objective-C 添加 iOS 平台特定实现</h3>

<p><em>注意</em>：以下步骤使用 Objective-C。如果你更喜欢 Swift，跳到步骤4b。</p>

<p>在 Xcode 中打开 Flutter 应用的 iOS 宿主端：</p>

<ol>
  <li>
    <p>打开 Xcode</p>
  </li>
  <li>
    <p>选择菜单项 ‘文件 &gt; 打开…’</p>
  </li>
  <li>
    <p>导航到 Flutter 应用程序的目录，选择它里面的 <code class="highlighter-rouge">ios</code> 文件夹。点击确定。</p>
  </li>
  <li>
    <p>确保 Xcode 工程编译没有错误。</p>
  </li>
  <li>
    <p>打开位于 Runner &gt; Runner 工程目录下的文件 <code class="highlighter-rouge">AppDelegate.m</code>。</p>
  </li>
</ol>

<p>下一步，创建 ‘FlutterMethodChannel’ 并在 <code class="highlighter-rouge">application
didFinishLaunchingWithOptions:</code> 方法中添加一个处理器。确保使用了和 Flutter 客户端同样的通道名。</p>

<pre><code class="language-objectivec">#import &lt;Flutter/Flutter.h&gt;

@implementation AppDelegate
- (BOOL)application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions {
  FlutterViewController* controller = (FlutterViewController*)self.window.rootViewController;

  FlutterMethodChannel* batteryChannel = [FlutterMethodChannel
                                          methodChannelWithName:@"samples.flutter.io/battery"
                                          binaryMessenger:controller];

  [batteryChannel setMethodCallHandler:^(FlutterMethodCall* call, FlutterResult result) {
    // TODO
  }];

  return [super application:application didFinishLaunchingWithOptions:launchOptions];
}
</code></pre>

<p>下一步，我们添加真正的 iOS ObjectiveC 代码，使用 iOS 电池接口取到电池电量。这些代码和你编写原生的 iOS 应用一样。</p>

<p>在 <code class="highlighter-rouge">AppDelegate</code> 类中，<code class="highlighter-rouge"><span class="k">@end</span></code> 之前接着添加一个新方法：</p>

<pre><code class="language-objectivec">- (int)getBatteryLevel {
  UIDevice* device = UIDevice.currentDevice;
  device.batteryMonitoringEnabled = YES;
  if (device.batteryState == UIDeviceBatteryStateUnknown) {
    return -1;
  } else {
    return (int)(device.batteryLevel * 100);
  }
}
</code></pre>

<p>最后，我们完成之前添加的 <code class="highlighter-rouge">setMethodCallHandler</code> 方法。我们需要一个单一的平台方法，<code class="highlighter-rouge">getBatteryLevel</code>，我们在 <code class="highlighter-rouge">call</code> 参数中检测它。这个平台方法的实现调用了我们在之前步骤中写的 iOS 代码，并在成功和错误的情况下都返回 <code class="highlighter-rouge">response</code> 参数。如果调用了一个未知的方法，我们会发出报告。</p>

<pre><code class="language-objectivec">[batteryChannel setMethodCallHandler:^(FlutterMethodCall* call, FlutterResult result) {
  if ([@"getBatteryLevel" isEqualToString:call.method]) {
    int batteryLevel = [self getBatteryLevel];

    if (batteryLevel == -1) {
      result([FlutterError errorWithCode:@"UNAVAILABLE"
                                 message:@"Battery info unavailable"
                                 details:nil]);
    } else {
      result(@(batteryLevel));
    }
  } else {
    result(FlutterMethodNotImplemented);
  }
}];
</code></pre>

<p>你现在应该能够在 iOS 系统上运行应用程序了。如果使用了 iOS 模拟器，注意它不支持电池相关接口，应用会显示 ‘无法获取电池信息’。</p>

<h3 id="example-swift">步骤 4b: 用 Swift 添加 iOS 平台特定实现</h3>

<p><em>注意</em>：以下步骤和步骤 3a 类似，除了用 Swift 代替 Objective-C。</p>

<p>本步骤假设你在<a href="#example-project">步骤 1.</a>中使用 <code class="highlighter-rouge">-i swift</code> 选项创建工程。</p>

<p>在 Xcode 中打开 Flutter 应用的 iOS 宿主端：</p>

<ol>
  <li>
    <p>打开 Xcode</p>
  </li>
  <li>
    <p>选择菜单项 ‘文件 &gt; 打开…’</p>
  </li>
  <li>
    <p>导航到 Flutter 应用程序的目录，选择它里面的 <code class="highlighter-rouge">ios</code> 文件夹。点击确定。</p>
  </li>
</ol>

<p>下一步，在使用 Objective-C 设置的标准模板中添加 Swift 支持：</p>

<ol>
  <li>
    <p>在工程中展开 Runner &gt; Runner。</p>
  </li>
  <li>
    <p>在工程中打开位于 Runner &gt; Runner 下的<code class="highlighter-rouge">AppDelegate.swift</code>。</p>
  </li>
</ol>

<p>下一步，重写 <code class="highlighter-rouge">application</code> 函数并创建一个 <code class="highlighter-rouge">FlutterMethodChannel</code> 绑定到通道 <code class="highlighter-rouge">samples.flutter.io/battery</code>：</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">@UIApplicationMain</span>
<span class="kd">@objc</span> <span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">FlutterAppDelegate</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span>
    <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplicationLaunchOptionsKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="kt">GeneratedPluginRegistrant</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="k">self</span><span class="p">);</span>

    <span class="k">let</span> <span class="nv">controller</span> <span class="p">:</span> <span class="kt">FlutterViewController</span> <span class="o">=</span> <span class="n">window</span><span class="p">?</span><span class="o">.</span><span class="n">rootViewController</span> <span class="k">as!</span> <span class="kt">FlutterViewController</span><span class="p">;</span>
    <span class="k">let</span> <span class="nv">batteryChannel</span> <span class="o">=</span> <span class="kt">FlutterMethodChannel</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"samples.flutter.io/battery"</span><span class="p">,</span>
                                                   <span class="nv">binaryMessenger</span><span class="p">:</span> <span class="n">controller</span><span class="p">);</span>
    <span class="n">batteryChannel</span><span class="o">.</span><span class="nf">setMethodCallHandler</span><span class="p">({</span>
      <span class="p">(</span><span class="nv">call</span><span class="p">:</span> <span class="kt">FlutterMethodCall</span><span class="p">,</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">FlutterResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="k">in</span>
      <span class="c1">// Handle battery messages.</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">super</span><span class="o">.</span><span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="nv">didFinishLaunchingWithOptions</span><span class="p">:</span> <span class="n">launchOptions</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>下一步, 我们添加真正的 iOS Swift 代码，使用 iOS 电池接口取到电池电量。这些代码和你编写原生的 iOS 应用一样。</p>

<p>在 <code class="highlighter-rouge">AppDelegate.swift</code> 底部添加下面的新方法：</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">func</span> <span class="nf">receiveBatteryLevel</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">FlutterResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">device</span> <span class="o">=</span> <span class="kt">UIDevice</span><span class="o">.</span><span class="n">current</span><span class="p">;</span>
  <span class="n">device</span><span class="o">.</span><span class="n">isBatteryMonitoringEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">batteryState</span> <span class="o">==</span> <span class="kt">UIDeviceBatteryState</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">result</span><span class="p">(</span><span class="kt">FlutterError</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">code</span><span class="p">:</span> <span class="s">"UNAVAILABLE"</span><span class="p">,</span>
                             <span class="nv">message</span><span class="p">:</span> <span class="s">"Battery info unavailable"</span><span class="p">,</span>
                             <span class="nv">details</span><span class="p">:</span> <span class="kc">nil</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">result</span><span class="p">(</span><span class="kt">Int</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">batteryLevel</span> <span class="o">*</span> <span class="mi">100</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>最后，我们完成之前添加的 <code class="highlighter-rouge">setMethodCallHandler</code> 方法。我们需要一个单一的平台方法，<code class="highlighter-rouge">getBatteryLevel</code>，我们在 <code class="highlighter-rouge">call</code> 参数中检测它。这个平台方法的实现调用了我们在之前步骤中写的 iOS 代码，并在成功和错误的情况下都返回 <code class="highlighter-rouge">response</code> 参数。如果调用了一个未知的方法，我们会发出报告。</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="n">batteryChannel</span><span class="o">.</span><span class="nf">setMethodCallHandler</span><span class="p">({</span>
  <span class="p">(</span><span class="nv">call</span><span class="p">:</span> <span class="kt">FlutterMethodCall</span><span class="p">,</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">FlutterResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="k">in</span>
  <span class="k">if</span> <span class="p">(</span><span class="s">"getBatteryLevel"</span> <span class="o">==</span> <span class="n">call</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">receiveBatteryLevel</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="n">result</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">result</span><span class="p">(</span><span class="kt">FlutterMethodNotImplemented</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>你现在应该能够在 iOS 系统上运行应用程序了。如果使用了 iOS 模拟器，注意它不支持电池相关接口，应用会显示 ‘无法获取电池信息’。</p>

<h2 id="separate">从 UI 代码中拆分平台特定的代码</h2>

<p>如果你希望在多个 Flutter 应用中使用平台特定代码，在主应用之外的目录，把代码拆分到平台插件中非常有用。更多细节请参考 <a href="/developing-packages/">开发扩展包</a>。</p>

<h2 id="publish">发布平台特定代码为扩展包</h2>

<p>如果你希望在 Flutter 的生态系统中和其他开发者分享自己的平台特定代码，更多细节请参考 <a href="/developing-packages/#publish">发布扩展包</a>。</p>

<h2 id="自定义通道和编解码器">自定义通道和编解码器</h2>

<p>除了上面提到的 <code class="highlighter-rouge">MethodChannel</code>，你也可以使用更简单的 <a href="https://docs.flutter.io/flutter/services/BasicMessageChannel-class.html"><code class="highlighter-rouge">BasicMessageChannel</code></a>，它使用自定义消息编解码器支持最基本的，异步消息传递。甚至，你可以使用特定的 <a href="https://docs.flutter.io/flutter/services/BinaryCodec-class.html"><code class="highlighter-rouge">BinaryCodec</code></a>, <a href="https://docs.flutter.io/flutter/services/StringCodec-class.html"><code class="highlighter-rouge">StringCodec</code></a>, 和
<a href="https://docs.flutter.io/flutter/services/JSONMessageCodec-class.html"><code class="highlighter-rouge">JSONMessageCodec</code></a> 类，或创建你自己的编解码器.</p>


</article>

          </div>
        </div>

        

      </div> <!-- /.row -->
    </div> <!-- /.container -->

    <footer class="site-footer">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <div class="logo">
          <img src="/images/flutter-mark-square-100.png" alt="Flutter Logo" width="100" height="100">
        </div>
        <p class="site-footer__link-list">
          <a href="https://groups.google.com/forum/#!forum/flutter-dev">flutter-dev@</a> &bull;
          <a href="https://twitter.com/flutterio">twitter</a> &bull;
          <a href="https://github.com/flutter/">github</a> &bull;
          <a href="/tos">terms</a> &bull;
          <a href="https://www.google.com/intl/en/policies/privacy/">privacy</a> &bull;
          <a href="https://github.com/orgs/flutter-dev/teams/flutter/">翻译组</a>
        </p>

        <p class="licenses">
          除非另有说明，否则本作品根据
          <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可证</a>进行许可，代码示例已根据 BSD 许可证进行许可。
        </p>
      </div>
    </div>
  </div>
</footer>

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="/js/sidebar_toggle.js"></script>
    <script src="/js/customscripts.js"></script>
    <script src="/js/prism.js"></script>
    <script src="/js/tabs.js"></script>
    <script src="/js/archive.js"></script>
    
    <script async="" defer="" src="//survey.g.doubleclick.net/async_survey?site=at3ul57xpub2vk3oxt2ytw365i"></script>
  </body>
</html>
